---
title: "01_CE211_Cleaning"
author: "Pratik Chaudhari"
date: "10/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load Libraries
```{r}
require(tidyverse)
require(lubridate)
require(stringr)
require(readxl)
require(tidyxl)
require(unpivotr)
```

Load Needs and Referrals Data from data folder
```{r}
col_types_needs <- c('numeric','date','text','text','numeric','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text')

col_types_referrals <- c('numeric','date','text','text','numeric','text','text','text','text','text','text','text','text','text','text','text','text')

col_types_monthly_report <- c('numeric','date','text','text','numeric','text','text','text','text','text','text','text','text','text','text','text','text')

needs_20192020 <- read_excel("../Data/Raw/NeedsbyTaxonomy20192020.xlsx",col_types = col_types_needs)
needs_20202021 <- read_excel("../Data/Raw/NeedsbyTaxonomy20202021.xlsx",col_types = col_types_needs)
referrals_20192020 <- read_excel("../Data/Raw/ReferralstoResources20192020.xlsx",col_types = col_types_referrals)
referrals_20202021 <- read_excel("../Data/Raw/ReferralstoResources20202021.xlsx",col_types = col_types_referrals)
```

Deduplicate Rows where row is exact duplicate
```{r}
needs_20192020 <- needs_20192020 %>% distinct()
needs_20202021 <- needs_20202021 %>% distinct()
referrals_20192020 <- referrals_20192020 %>% distinct()
referrals_20202021 <- referrals_20202021 %>% distinct()
```


Merge dataframes
```{r}
needs <- rbind(needs_20192020,needs_20202021)
referrals <- rbind(referrals_20192020,referrals_20202021)
```

Filter Dataframes for Mecklenburg
```{r}
needs <- needs %>% filter(toupper(County) == 'MECKLENBURG')
referrals <- referrals %>% filter(toupper(County) == 'MECKLENBURG')
```

Type convert
```{r}
needs <- needs %>% mutate(Age = as.factor(Age), Gender = as.factor(Gender), Language = as.factor(Language)
                          ,`Military Status` = as.factor(`Military Status`)
                          ,`Disability Status` = as.factor(`Disability Status`)
                          ,`Disability Type` = as.factor(`Disability Type`)
                          ,`Health Insurance` = as.factor(`Health Insurance`)
                          , Need = as.factor(Need));

referrals <- referrals %>% mutate(Age = as.factor(Age), Gender = as.factor(Gender), Language = as.factor(Language)
                          ,`Military Status` = as.factor(`Military Status`)
                          ,`Disability Status` = as.factor(`Disability Status`)
                          ,`Disability Type` = as.factor(`Disability Type`)
                          ,`Health Insurance` = as.factor(`Health Insurance`))
```

Rename columns, add '_'

```{r}
colnames(needs) <- gsub(pattern = ' ',x=colnames(needs),replacement = '_')
colnames(referrals) <- gsub(pattern = ' ',x=colnames(referrals),replacement = '_')
```

Change DV Referral;Literally Homeless to Literally Homeless;DV Referral

```{r}
needs$CE_Screened <- gsub(x=needs$CE_Screened,pattern = 'DV Referral;Literally Homeless',replacement = 'Literally Homeless;DV Referral')
```


Check for ';' in CE_Screened column
```{r}
head(needs %>% filter(str_detect(CE_Screened,";")))
needs <- separate_rows(needs,'CE_Screened',sep=";")
head(needs)
```

Check for ';' in Referral column
```{r}
head(needs %>% filter(str_detect(Referral,";")))
needs <- separate_rows(needs,'Referral',sep=";")
head(needs)
```
Check for ';' in Disability_Type column
```{r}
head(needs %>% filter(str_detect(Disability_Type,";")))
needs <- separate_rows(needs,'Disability_Type',sep=";")
head(needs)
```


Upper All Column Names
```{r}
colnames(needs) <- toupper(colnames(needs))
colnames(referrals) <- toupper(colnames(referrals))

```

Write to Intermediate file
```{r}
write.csv(x = needs,"../Data/Cleaned/01_Needs.csv",row.names = F)
write.csv(x = referrals,"../Data/Cleaned/01_referrals.csv",row.names = F)
```

```{r}
skip_rows = 20
skill_english <- "211 Coordinated Entry English Skill"
skill_spanish <- "SKILL: 211 Coordinated Spanish Skill"
col_names <- c("DATE","...2" ,"...3","CALLS" ,"...5","AGENT count" ,"Reporting.Abandon_Disposition count","ABANDONED count" 
               ,"ABANDONED (%rec)","Average HANDLE TIME" ,"Average SPEED OF ANSWER","Average QUEUE WAIT TIME" 
               ,"Average HOLD TIME","SERVICE LEVEL (%rec)" ,"Average CallSurvey.211CSATQ1MoreInfo"
               ,"CallSurvey.211CSATQ1MoreInfo count" ,"Average CallSurvey.211CSATQ2AgentSatisfaction", 
               "CallSurvey.211CSATQ2AgentSatisfaction count" ,"Average CallSurvey.211CSATQ3Recommendation" 
               ,"CallSurvey.211CSATQ3Recommendation count" ,"CallSurvey.CallSurvey.opt_in count","Reporting.Queue Callback count" 
               ,"file_name","sheet_name")
col_types <- c('date','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text','text')
```

Monthly Report Cleaning
For each sheet perform the below operation

```{r}
file_list <- list.files(path = '../Data/Raw',pattern = '^CE Monthly Report*',full.names = T)

for(file in file_list){
  df <- data.frame(matrix(ncol = 24, nrow = 0))

  sheet_list <- excel_sheets(file)
  sheet_list <- sheet_list[2:length(sheet_list)]

  for(sheet in sheet_list){
    CEMonthly_raw <- read_excel(file,sheet = sheet,skip = 20,trim_ws = T,col_types=col_types)
    cols_missing <- setdiff(col_names,names(CEMonthly_raw))
    CEMonthly_raw[cols_missing] <- NA
    CEMonthly_raw <- CEMonthly_raw %>% select(col_names)
    CEMonthly_raw <- CEMonthly_raw %>% fill(...2,.direction = 'down')
    CEMonthly_raw <- CEMonthly_raw [rowSums(is.na(CEMonthly_raw )) != ncol(CEMonthly_raw ),]
    CEMonthly_raw <- CEMonthly_raw %>% mutate(file_name = gsub(x=basename(file_list[1]),pattern=" ",replacement = "_"),sheet_name = sheet)
    CEMonthly_raw <- CEMonthly_raw %>% mutate(...3 = if_else(str_detect(...2,"SKILL:"),...2,as.character(NA)))
    CEMonthly_raw <- CEMonthly_raw %>% fill(...3,.direction = 'down')
    df <- rbind(CEMonthly_raw,df)
  }
  
  write.csv(df,paste('../Data/Cleaned/01_CE_Report_Stage_1/'
                                ,gsub(x = gsub(x=basename(file),pattern=" ",replacement = "_"),pattern = '.xlsx',replacement = '.csv')
                                ,sep = ''),row.names = F)
}
```

Read from Cleaned Monthly Report Files
```{r}
CEMonthly_2019 <- read.csv("../Data/Cleaned/01_CE_Report_Stage_1/CE_Monthly_Report_2019.xlsx")
```